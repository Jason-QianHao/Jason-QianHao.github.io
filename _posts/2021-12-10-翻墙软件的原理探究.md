---
title: 翻墙软件的原理探究
tags: 网络与Web基础
---

# 翻墙软件的原理探究

>转载和参考：
>
>- https://www.hack520.com/330.html
>- [上网限制和翻墙基本原理](https://superxlcr.github.io/2018/07/01/上网限制和翻墙基本原理/)

主要分为几个原因和相应解决办法：

- DNS污染和劫持
- 封锁IP
- 封锁HTTP代理
- 封锁VPN

另外还有一些工具介绍。

# DNS污染和劫持

## DNS劫持

- **DNS劫持**：DNS Hijacking。就是通过劫持了DNS服务器，通过某些手段取得某域名的解析记录控制权，进而修改此域名的解析结果，**导致对该域名的访问由原IP地址转入到修改后的指定IP**，其结果就是对特定的网址不能访问或访问的是假网址，从而实现窃取资料或者破坏原有正常服务的目的。DNS劫持通过篡改DNS服务器上的数据返回给用户一个错误的查询结果来实现的。

- DNS劫持症状：在某些地区的用户在成功连接宽带后，首次打开任何页面都指向ISP提供的“电信互联星空”、“网通黄页广告”等内容页面。还有就是曾经出现过用户访问Google域名的时候出现了[百度](https://www.hack520.com/topic/baidu/)的网站。这些都属于DNS劫持。

<img src="https://cdn.hack520.com/images/2018/56.png" alt="DNS劫持示意图" style="zoom:75%;" />

## DNS污染

- **DNS污染**，又称为域名服务器缓存污染（DNS cache pollution）或者域名服务器快照侵害（DNS cache poisoning）。 DNS污染是指一些刻意制造或无意中制造出来的域名服务器分组，把域名指往不正确的IP地址。它是一种让一般用户由于得到虚假目标主机IP而不能与其通信的方法，是一种DNS缓存投毒攻击（DNS cache poisoning）。其工作方式是：由于通常的DNS查询没有任何认证机制，而且DNS查询通常基于的UDP是无连接不可靠的协议，因此DNS的查询非常容易被篡改，通过对UDP端口53上的DNS查询进行入侵检测，一经发现与关键词相匹配的请求则立即伪装成目标域名的解析服务器（NS，Name Server）给查询者返回虚假结果。DNS污染是发生在用户请求的第一步上，直接从协议上对用户的DNS请求进行干扰。

- DNS污染症状：目前一些被禁止访问的网站很多就是通过DNS污染来实现的，例如YouTube、Facebook等网站。

举个例子易于理解：这招是GFW常用的。你访问google.com 因为人家服务器在国外，你的DNS过去解析，肯定要走国际带宽的出口，然后就被GFW逮住了。因为DNS 走的是UDP协议，且UDP又没有什么校验机制，只管发送。所以这时候，GFW就假装成DNS服务器回应你了，而此时真正的请求可能正在被真正的DNS服务器处理，假的已经返回给你了，浏览器就选择了最快返回的那个地址去解析了。当然是一个不可用的地址啦。

因为DNS 走的UDP协议，并且是53端口，所以这有多好发现也就不言而喻了。如果你强行让DNS走TCP协议，GFW 有办法让你连接重置，虽然污染不了你的DNS，但是你还是无法获得ip。也就是为什么有一种FQ方式就叫修改host 文件，修改后，域名不需要去DNS服务器请求了，直接在你的操作系统里就已经解析出了ip 地址。但是，GFW还是会定期封杀这些网站的ip地址，你的host就没用了。

## 解决方法

解决办法：

1. 使用[OpenDNS](https://www.opendns.com/setupguide/)（208.67.222.222）或[GoogleDNS](https://developers.google.com/speed/public-dns/)（8.8.8.8）（现在不太好用，被封锁，速度慢）
2. 使用一些第三方的DNS服务器
3. 自己用VPS搭建DNS服务器
4. 修改机器host文件，直接IP访问

# 封锁IP

通过上面一些方式，可以绕过DNS污染，通过IP地址访问无法访问的网页。但是目前针对IP进行大范围的封锁。虽然google这种大公司有很多镜像IP地址，但是目前基本全部被封锁掉，有漏网的可能也坚持不了多久。而且很多小公司的服务是部署在一些第三方的主机上，所以封锁IP有时会误伤，封锁一个IP导致主机上本来可以使用的页面也无法访问了。

不过目前不可能把所有国外的IP全部封锁掉，所以我们采用机会从国内连接到国外的VPS，进行翻墙。

解决办法：

1. 使用VPS搭建代理
2. 使用IPV6 （IPV6地址巨大，采用封地址不现实，但是目前国内只有部分高校部署了IPV6）

# 封锁HTTP代理

对于没有办法搭建VPS的人来说，最好的办法就是使用HTTP代理。

## HTTP代理和封锁

客户端不在直接请求目标服务器，而是请求代理服务器，代理服务器在去请求目标服务器。然后返回结果。

![代理示意图](https://gitee.com/Object_Jason/my-pic-go/raw/master/img/1.png)

对于HTTP代理来说，封锁起来非常简单。因为HTTP协议是明文，Request Message中就带有要请求的URL或IP地址，这样很容易就被检测到。对于HTTPS来说，虽然通信是进行加密了，但是在建连之前会给代理服务器发送CONNECT方法，这里也会带上要访问的远端服务器地址。如果代理服务器在国外，在出去前就会被检测到。 如果代理服务器在国内，呵呵，你也出不去啊。

对于HTTP代理，因为是明文，所以很容易被服务器了解你的一些数据。**所以不要随便使用第三方的HTTP代理访问HTTP网站，而HTTPS虽然不知道你的数据，但是可以知道你去了那里。**

## 解决方法

解决办法：

1. 使用VPS搭建VPN
2. 使用第三方VPN

# 封锁VPN

## VPN

**虚拟专用网**（英语：**Virtual Private Network**，简称**VPN**），是一种常用于连接中、大型企业或团体与团体间的私人网络的通讯方法。虚拟私人网络的讯息透过公用的网络架构（例如：[互联网](https://zh.wikipedia.org/wiki/互联网)）来传送[内联网](https://zh.wikipedia.org/wiki/内部网)的网络讯息。它利用已加密的[通道协议](https://zh.wikipedia.org/wiki/隧道协议)（Tunneling Protocol）来达到保密、发送端认证、消息准确性等私人消息安全效果。

![VPN示意图](https://gitee.com/Object_Jason/my-pic-go/raw/master/img/2.jpg)

正常网络通信时，所有网络请求都是通过我们的物理网卡直接发送出去。而VPN是客户端使用相应的VPN协议先与VPN服务器进行通信，成功连接后就在操作系统内建立一个虚拟网卡，一般来说默认PC上所有网络通信都从这虚拟网卡上进出，经过VPN服务器中转之后再到达目的地。

![VPN发送流程示意图](https://gitee.com/Object_Jason/my-pic-go/raw/master/img/3.png)

通常VPN协议都会对数据流进行强加密处理，从而使得第三方无法知道数据内容，这样就实现了翻墙。翻墙时VPN服务器知道你干的所有事情（HTTP，对于HTTPS，它知道你去了哪）。

VPN有多种协议：OPENVPN、PPTP、L2TP/IPSec、SSLVPN、IKEv2 VPN，Cisco VPN等。其中的PPTP和L2TP是明文传输协议。只负责传输，不负责加密。分别利用了MPPE和IPSec进行加密。

## 封锁方式

对于VPN和其他一些加密的传输的协议来说，没有办法直接获取明文的请求信息，所以没有办法直接封锁，而是使用了监控的方式：

- 暴力破解

  对于一些使用弱加密方式的协议来说，直接使用暴力破解检查传输内容。比如PPTP使用MPPE加密，但是MPPE是基于RC4，对于强大的防火墙背后的超级计算机集群，破解就是几秒钟的事情。

  破解后明文中一旦包含了违禁内容，请求就会被封。而对应的IP可能会进入重点关怀列表。

- 特征检测

  要想成功翻墙都必须与对应的远程服务器建立连接，然后再用对应的协议进行数据处理并传输。
  而问题就出在这里：翻墙工具和远程服务器建立连接时，如果表现的很独特，在一大堆流量里很显眼，就会轻易被GFW识别出从而直接阻断连接，而VPN（尤其是OPENVPN）和SSH这方面的问题尤其严重。

- 流量监控

  当一个VPN地址被大量人请求，并保持长时间连接时，就很容易引起关注。SSH接口有大量数据请求。一般会结合其他特征。

- 深度包检测

  **深度数据包检测**（英语：Deep packet inspection，缩写为 DPI），又称**完全数据包探测**（complete packet inspection）或**信息萃取**（Information eXtraction，IX），是一种电脑网络数据包过滤技术，用来检查通过检测点之[数据包](https://zh.wikipedia.org/wiki/網路封包)的数据部分（亦可能包含其[标头](https://zh.wikipedia.org/wiki/信头)），以搜索不匹配规范之协议、病毒、垃圾邮件、入侵，或以预定之准则来决定数据包是否可通过或需被路由至其他不同目的地，亦或是为了收集统计数据之目的。

<img src="https://gitee.com/Object_Jason/my-pic-go/raw/master/img/11.png" alt="VPN原理示意图" style="zoom:67%;" />

# 关于Shadowsocks

## Socks代理/SSH Socks

**SOCKS**是一种网络传输协议，主要用于客户端与外网服务器之间通讯的中间传递。SOCKS是”SOCKetS”的缩写[1]。
当防火墙后的客户端要访问外部的服务器时，就跟SOCKS代理服务器连接。这个代理服务器控制客户端访问外网的资格，允许的话，就将客户端的请求发往外部的服务器。
这个协议最初由David Koblas开发，而后由NEC的Ying-Da Lee将其扩展到版本4。最新协议是版本5，与前一版本相比，增加支持UDP、验证，以及IPv6。
根据OSI模型，SOCKS是会话层的协议，位于表示层与传输层之间

- 与HTTP代理的对比

SOCKS工作在比HTTP代理更低的层次：SOCKS使用握手协议来通知代理软件其客户端试图进行的连接SOCKS，然后尽可能透明地进行操作，而常规代理可能会解释和重写报头（例如，使用另一种底层协议，例如FTP；然而，HTTP代理只是将HTTP请求转发到所需的HTTP服务器）。虽然HTTP代理有不同的使用模式，CONNECT方法允许转发TCP连接；然而，SOCKS代理还可以转发UDP流量和[反向代理](https://zh.wikipedia.org/wiki/反向代理)，而HTTP代理不能。HTTP代理通常更了解HTTP协议，执行更高层次的过滤（虽然通常只用于GET和POST方法，而不用于CONNECT方法）

Socks代理本身协议是明文传输，虽然相对HTTP有一些优势，但是明文也导致Socks代理很容易被封。所以可以考虑对Socks进行加密。所以出现了SSH Socks，对于MAC和Linux来说，不需要Client就可以进行访问。详细可以看：[SSH隧道技术简介：端口转发&SOCKS代理](https://my.oschina.net/leejun2005/blog/94401)

但是网上看有些地区好像会对一些VPS的SSH进行端口干扰。我在武汉好像SSH到我的VPS一会就会断。在上海一直没这问题。而且SSH一般是小流量数据，如果数据量特别大，也会被认为是翻墙，进入特别关怀列表。

## Shadowsocks

**认准官网：**https://shadowsocks.org/en/index.html **（.com那个是卖账号的）**

```
A secure socks5 proxy,
designed to protect your Internet traffic.
```

Shadowsocks 目前不容易被封杀主要是因为：

1. 建立在socks5协议之上，socks5是运用很广泛的协议，所以没办法直接封杀socks5协议
2. 使用socks5协议建立连接，而没有使用VPN中的服务端身份验证和密钥协商过程。而是在服务端和客户端直接写死密钥和加密算法。所以防火墙很难找到明显的特征，因为这就是个普通的socks5协议。
3. Shadowsock搭建也比较简单，所以很多人自己架设VPS搭建，个人使用流量也很小，没法通过流量监控方式封杀。
4. 自定义加密方式和密钥。因为加密主要主要是防止被检测，所以要选择安全系数高的加密方式。之前RC4会很容易被破解，而导致被封杀。所以现在推荐使用AES加密。而在客户端和服务端自定义密钥，泄露的风险相对较小。

**所以如果是自己搭建的Shadosocks被封的概率很小，但是如果是第三方的Shadeowsocks，密码是server定的，你的数据很可能遭受到中间人攻击。**

顺便说一下，Shadowssocks是天朝的clowwindy大神写的。不过Shadowsocks项目源码已经从github上删除了并停止维护了，但是release中还有源码可以下载。https://github.com/shadowsocks/shadowsocks